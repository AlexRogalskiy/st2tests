---
version: '2.0'

examples.mistral-ask:
    description: A workflow for demonstrating st2.ask functionality
    type: direct

    task-defaults:
        on-error:
            - rejected

    tasks:

        initial_task:
            action: core.local
            input:
                cmd: echo "Beginning approval example workflow"
            on-complete:
                - basic_approval


        # We hit our first approval task. The first time this action runs, the execution context will be empty, so
        # naturally, this data will fail to validate, so the action will return an `pending` status, and this workflow
        # will be paused. It will remain in this state until someone passes additional data into the executions API.
        # When this happens, the action will re-run, and re-attempt to validate the data in the context. If this data
        # validates, the action will return a success status and will continue with the workflow.
        #
        # If it does not validate, it will return to `pending` status.
        #
        # Note that the optional "schema" parameter is supplied down in the "ask_for_2fa_token" task, but is omitted here.
        # By default, `st2.ask` will use the default JSON schema (with a bit of built-in logic) that validates a
        # simple approve/reject response stored in the execution context.
        # When this happens, the `st2.ask` will have a bit of conditional logic to detect the approve/reject status
        # and return a success or failed state.
        #
        # So, if someone approves this, such as via an `st2 approve` command, it will continue to task2
        basic_approval:
            action: st2.ask
            input:
                tag: managers
                # Note that the "users" and "roles" parameters are omitted here, so anyone can respond to this task
            on-success:
                - task2

        task2:
            action: core.local
            input:
                cmd: echo "Got to task1"    
            on-complete:
                - ask_for_2fa_token

        # Now, we arrive at our second approval example. We know that one of the upcoming tasks "send_request_with_2fa"
        # requires a password AND a second factor for authentication. We can provide the password here (or in st2kv of course)
        # but for the second factor, we need to ask someone to intervene.
        #
        # In this instance of `st2.ask`, the same initial treatment applies. The execution context is empty,
        # so naturally, it will fail to validate, and the action will return `pending` status.
        #
        # Note that we're providing our own JSON schema to the `schema` parameter here. `st2.ask` will
        # use this to validate data stored in the execution context instead of the default schema that
        # validates a simple approve/reject response from the user.
        # When we do this, the action doesn't have a way of knowing what a "rejected" approval means,
        # so this will block in `pending` status until someone sends data into the context that will validate
        # the schema.
        # In this event, the user may want to look into writing their own action that has more detailed checks of
        # the data once validated, if they need this.
        ask_for_2fa_token:
            action: st2.ask
            input:
                schema:
                    title: response_data
                    type: object
                    properties:
                        second_factor:
                           type: string
                           description: Please enter passcode for the second factor authentication
                           secret: true
                    required: ["second_factor"]
                tag: developers

                # The "roles" param is one way of restricting who is able to respond to this instance of st2.ask
                # In this case, only those in a role labeled "developers" will be allowed to respond to this action
                #
                # NOTE this requires RBAC support, which is only available in the Enterprise version of StackStorm.
                # See the "users" param for a similar way that doesn't require RBAC
                roles:
                    - developers
            publish:
                second_factor: <% task(ask_for_2fa_token).result.second_factor %>
            on-success:
                - send_request_with_2fa

        # Here, we're using the "second_factor" variable published in the previous st2.ask action as input to this action.
        # This demonstrates not only the ability for st2.ask to pause a workflow, but to retrieve information at runtime
        # that's required for a future action.
        send_request_with_2fa:
            action: testpack.request_with_2fa
            input:
                username: foo
                password: bar
                token: <% $.second_factor %>
            on-success:
                - bob_response
                - fred_response
                - do_risky_thing_that_needs_two_approvers

        # This final st2.ask example illustrates how multiple responders can be used to satisfy an st2.ask action.
        # In this case, we create two separate st2.ask tasks, one for each approver.
        bob_response:
            action: st2.ask
            input:
                schema:
                    title: response_data
                    type: object
                    properties:
                        bob_token:
                           type: string
                           description: Please enter bob's token
                           secret: true
                    required: ["bob_token"]
                tag: bob

                # The "users" param is similar to "roles" in that it restricts who can respond to this instance of st2.ask.
                # This is a less flexible option, because you must explicitly mention specific usernames, but it doesn't require
                # the RBAC functionality, and as a result, this is allowed in the community edition of StackStorm
                users:
                    - bob
            publish:
                bob_token: <% task(bob_response).result.bob_token %>

        fred_response:
            action: st2.ask
            input:
                schema:
                    title: response_data
                    type: object
                    properties:
                        fred_token:
                           type: string
                           description: Please enter fred's token
                           secret: true
                    required: ["fred_token"]
                tag: fred

                # The "users" param is similar to "roles" in that it restricts who can respond to this instance of st2.ask.
                # This is a less flexible option, because you must explicitly mention specific usernames, but it doesn't require
                # the RBAC functionality, and as a result, this is allowed in the community edition of StackStorm
                users:
                    - fred
            publish:
                fred_token: <% task(fred_response).result.fred_token %>

        # Again, we're using the variables published by the previous action to drive this one.
        do_risky_thing_that_needs_two_approvers:
            action: testpack.do_risky_thing_that_needs_two_approvers
            input:
                bob_token: <% $.bob_token %>
                fred_token: <% $.fred_token %>

        rejected:
            action: core.local
            input:
                cmd: echo "Workflow approval was rejected, or some other failure occurred."
