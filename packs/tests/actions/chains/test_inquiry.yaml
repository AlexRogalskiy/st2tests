---

# Workflow for testing Inquiry functionality with an ActionChain workflow

chain:

# Executing inquiry workflow via CLI instead of directly via ref so this workflow doesn't get paused
- name: "execute_inquiry_workflow"
  ref: "core.local"
  params:
    env:
      ST2_BASE_URL: "{{protocol}}://{{hostname}}"
      ST2_AUTH_URL: "{{protocol}}://{{hostname}}:9100"
      ST2_API_URL: "{{protocol}}://{{hostname}}:9101"
      ST2_AUTH_TOKEN: "{{token}}"
    cmd: ". virtualenv/bin/activate && st2 run examples.chain-test-inquiry"
  on-success: "get_inquiry_id"

- name: "get_inquiry_id"
  ref: "core.local"
  params:
    env:
      ST2_BASE_URL: "{{protocol}}://{{hostname}}"
      ST2_AUTH_URL: "{{protocol}}://{{hostname}}:9100"
      ST2_API_URL: "{{protocol}}://{{hostname}}:9101"
      ST2_AUTH_TOKEN: "{{token}}"
    cmd: '. virtualenv/bin/activate && echo $(st2 inquiry list | grep -o "[0-9a-f]\{24\}" | tail -1)'
  on-success: "get_workflow_id"

- name: "get_workflow_id"
  ref: "core.local"
  params:
    env:
      ST2_BASE_URL: "{{protocol}}://{{hostname}}"
      ST2_AUTH_URL: "{{protocol}}://{{hostname}}:9100"
      ST2_API_URL: "{{protocol}}://{{hostname}}:9101"
      ST2_AUTH_TOKEN: "{{token}}"
    cmd: '. virtualenv/bin/activate && echo $(st2 execution list -a id --action=examples.chain-test-inquiry | grep -o "[0-9a-f]\{24\}" | tail -1)'
  on-success: "get_workflow_details_1"

- name: "get_workflow_details_1"
  ref: "core.local"
  params:
    env:
      ST2_BASE_URL: "{{protocol}}://{{hostname}}"
      ST2_AUTH_URL: "{{protocol}}://{{hostname}}:9100"
      ST2_API_URL: "{{protocol}}://{{hostname}}:9101"
      ST2_AUTH_TOKEN: "{{token}}"
    cmd: '. virtualenv/bin/activate && st2 execution get -j {{ get_workflow_id.stdout }}'
  on-success: "invalid_response_expect_failure"

- name: "invalid_response_expect_failure"
  ref: "core.local"
  params:
    env:
      ST2_BASE_URL: "{{protocol}}://{{hostname}}"
      ST2_AUTH_URL: "{{protocol}}://{{hostname}}:9100"
      ST2_API_URL: "{{protocol}}://{{hostname}}:9101"
      ST2_AUTH_TOKEN: "{{token}}"
    cmd: ". virtualenv/bin/activate && st2 inquiry respond -r '{\"continue\": 123}' {{ get_inquiry_id.stdout }}"
  on-failure: "get_workflow_details_2"
  on-success: "fail"

- name: "get_workflow_details_2"
  ref: "core.local"
  params:
    env:
      ST2_BASE_URL: "{{protocol}}://{{hostname}}"
      ST2_AUTH_URL: "{{protocol}}://{{hostname}}:9100"
      ST2_API_URL: "{{protocol}}://{{hostname}}:9101"
      ST2_AUTH_TOKEN: "{{token}}"
    cmd: '. virtualenv/bin/activate && st2 execution get -j {{ get_workflow_id.stdout }}'
  on-success: "valid_response_expect_failure"

- name: "valid_response_expect_failure"
  ref: "core.local"
  params:
    env:
      ST2_BASE_URL: "{{protocol}}://{{hostname}}"
      ST2_AUTH_URL: "{{protocol}}://{{hostname}}:9100"
      ST2_API_URL: "{{protocol}}://{{hostname}}:9101"
      ST2_AUTH_TOKEN: "{{token}}"
    cmd: ". virtualenv/bin/activate && st2 inquiry respond -r '{\"continue\": true}' {{ get_inquiry_id.stdout }}"
  on-success: "get_workflow_details_3"

- name: "get_workflow_details_3"
  ref: "core.local"
  params:
    env:
      ST2_BASE_URL: "{{protocol}}://{{hostname}}"
      ST2_AUTH_URL: "{{protocol}}://{{hostname}}:9100"
      ST2_API_URL: "{{protocol}}://{{hostname}}:9101"
      ST2_AUTH_TOKEN: "{{token}}"
    cmd: '. virtualenv/bin/activate && st2 execution get -j {{ get_workflow_id.stdout }}'
  on-success: "duplicate_response"

- name: "duplicate_response"
  ref: "core.local"
  params:
    env:
      ST2_BASE_URL: "{{protocol}}://{{hostname}}"
      ST2_AUTH_URL: "{{protocol}}://{{hostname}}:9100"
      ST2_API_URL: "{{protocol}}://{{hostname}}:9101"
      ST2_AUTH_TOKEN: "{{token}}"
    cmd: ". virtualenv/bin/activate && st2 inquiry respond -r '{\"continue\": true}' {{ get_inquiry_id.stdout }}"
  on-success: "fail"
  on-failure: assert_workflow_paused_prep

###########
# ASSERTS #
###########

# Summary of assertions to make:
# - Confirm workflow is paused
# - Confirm trigger-instance was fired
# - Confirm bad response was NOT accepted
# - Confirm workflow STILL paused
# - Confirm good response was accepted
# - Confirm workflow is resumed

# Temporary hack because st2 execution get prints invalid json for workflows
- name: "assert_workflow_paused_prep"
  ref: "core.local"
  params:
    cmd: echo " { $(echo '{{ get_workflow_details_1.stdout }}' | grep paused) } "
  on-success: "assert_workflow_paused"

- name: "assert_workflow_paused"
  ref: "asserts.object_equals"
  params:
    object: "{{ assert_workflow_paused_prep.stdout }}"
    expected:
      status: paused
  on-success: "assert_workflow_still_paused_prep"


# Temporary hack because st2 execution get prints invalid json for workflows
- name: "assert_workflow_still_paused_prep"
  ref: "core.local"
  params:
    cmd: echo " { $(echo '{{ get_workflow_details_2.stdout }}' | grep paused) } "
  on-success: "assert_workflow_still_paused"

- name: "assert_workflow_still_paused"
  ref: "asserts.object_equals"
  params:
    object: "{{ assert_workflow_still_paused_prep.stdout }}"
    expected:
      status: paused
  on-success: "assert_workflow_succeeded_prep"


# Temporary hack because st2 execution get prints invalid json for workflows
- name: "assert_workflow_succeeded_prep"
  ref: "core.local"
  params:
    cmd: echo " { $(echo '{{ get_workflow_details_3.stdout }}' | grep succeeded | head -1) } "
  on-success: "assert_workflow_succeeded"

- name: "assert_workflow_succeeded"
  ref: "asserts.object_equals"
  params:
    object: "{{ assert_workflow_succeeded_prep.stdout }}"
    expected:
      succeeded: True

- name: "fail"
  ref: core.local
  cmd: exit 1